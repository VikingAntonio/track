<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Menutech - Generador de Video</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0; background:linear-gradient(180deg,#071225,#0b1628);
      font-family:'Inter',sans-serif; color:#e6eef6;
    }
    h1 { text-align:center; margin:20px 0; font-size:22px; }
    .grid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:20px; padding:20px; max-width:1200px; margin:0 auto;
    }
    .section {
      background:rgba(255,255,255,0.04);
      border-radius:16px; padding:16px;
      border:1px solid rgba(255,255,255,0.05);
      box-shadow:0 4px 14px rgba(0,0,0,0.4);
      display:flex; flex-direction:column; gap:12px;
      transition:all .3s ease;
    }
    .section:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(16,185,129,.1); }
    .section h2 { font-size:16px; margin:0; color:#b7fff0; letter-spacing:.5px; }
    .dropzone {
      position:relative; border:2px dashed rgba(255,255,255,0.08);
      border-radius:14px; height:220px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,0.02);
      cursor:pointer; overflow:hidden; flex-wrap:wrap; padding:8px;
      transition:all .3s ease;
    }
    .dropzone.dragover { border-color:#10b981; background:rgba(16,185,129,0.06); }
    .dropzone .plus { font-size:60px; color:rgba(255,255,255,0.3); transition:all .3s ease; user-select:none; }
    .dropzone:hover .plus { transform:rotate(90deg); color:#10b981; }
    .preview { display:flex; flex-wrap:wrap; gap:6px; width:100%; justify-content:center; }
    .preview img {
      width:90px; height:90px; object-fit:cover; border-radius:8px;
      border:1px solid rgba(255,255,255,0.1); transition:transform .2s ease;
    }
    .preview img:hover { transform:scale(1.08); }
    .controls { text-align:center; margin:20px; }
    .controls select, .controls button {
      background:#0f213e; color:#b7fff0; border:1px solid rgba(255,255,255,0.15);
      border-radius:8px; padding:10px 14px; font-size:14px;
      cursor:pointer; margin:5px; transition:all .2s ease;
    }
    .controls button:hover { background:#10b981; color:#fff; transform:scale(1.03); }
    #status { text-align:center; color:#aaa; margin:20px 0; min-height:24px; }
    .spinner {
      border:4px solid rgba(255,255,255,0.1);
      border-left:4px solid #10b981;
      border-radius:50%;
      width:24px; height:24px;
      display:inline-block;
      animation:spin 1s linear infinite;
      vertical-align:middle;
      margin-right:8px;
    }
    @keyframes spin { 100% { transform:rotate(360deg);} }
  </style>
</head>
<body>

<h1>Generador de videos Menutech</h1>

<div class="grid">
  <div class="section">
    <h2>Interior</h2>
    <div class="dropzone" id="drop-interior">
      <span class="plus">+</span>
      <input type="file" accept="image/*" multiple hidden>
      <div class="preview"></div>
    </div>
  </div>

  <div class="section">
    <h2>Platillos</h2>
    <div class="dropzone" id="drop-platillos">
      <span class="plus">+</span>
      <input type="file" accept="image/*" multiple hidden>
      <div class="preview"></div>
    </div>
  </div>

  <div class="section">
    <h2>Exterior</h2>
    <div class="dropzone" id="drop-exterior">
      <span class="plus">+</span>
      <input type="file" accept="image/*" multiple hidden>
      <div class="preview"></div>
    </div>
  </div>
</div>

<div class="controls">
  <label>OrientaciÃ³n:</label>
  <select id="orientation">
    <option value="horizontal">Horizontal (1920x1080)</option>
    <option value="vertical">Vertical (1080x1920)</option>
  </select>
  <button id="generateBtn">ðŸŽ¬ Generar Video</button>
</div>

<div id="status">Arrastra o haz clic en los cuadros para cargar imÃ¡genes</div>

<!-- âœ… CORRECTO: versiÃ³n UMD funcional -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

<script>
const zones = document.querySelectorAll(".dropzone");
const allImages = [];
const generateBtn = document.getElementById("generateBtn");
const orientationSelect = document.getElementById("orientation");
const statusEl = document.getElementById("status");

zones.forEach(zone => {
  const fileInput = zone.querySelector("input[type=file]");
  const preview = zone.querySelector(".preview");
  const plus = zone.querySelector(".plus");

  zone.addEventListener("click", e => {
    if (e.target === plus || e.target === zone) fileInput.click();
  });
  fileInput.addEventListener("change", e => handleFiles(e.target.files, preview));

  zone.addEventListener("dragover", e => { e.preventDefault(); zone.classList.add("dragover"); });
  zone.addEventListener("dragleave", e => { e.preventDefault(); zone.classList.remove("dragover"); });
  zone.addEventListener("drop", e => {
    e.preventDefault(); zone.classList.remove("dragover");
    handleFiles(e.dataTransfer.files, preview);
  });
});

function handleFiles(files, previewEl) {
  Array.from(files).forEach(file => {
    if (!file.type.startsWith("image/")) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement("img");
      img.src = e.target.result;
      previewEl.appendChild(img);
      allImages.push(e.target.result);
    };
    reader.readAsDataURL(file);
  });
}

generateBtn.addEventListener("click", async () => {
  if (allImages.length === 0) {
    alert("Por favor, sube al menos una imagen.");
    return;
  }

  const spinner = document.createElement("span");
  spinner.className = "spinner";
  statusEl.innerHTML = "";
  statusEl.appendChild(spinner);
  statusEl.append(" Generando video... por favor espera");

  try {
    // ðŸ•’ Esperamos a que FFmpeg estÃ© disponible
    await waitForFFmpeg();

    const { createFFmpeg, fetchFile } = window.FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    await ffmpeg.load();

    const orientation = orientationSelect.value;
    const targetW = orientation === "horizontal" ? 1920 : 1080;
    const targetH = orientation === "horizontal" ? 1080 : 1920;
    const DURATION = 3;
    const FADE = 1.5;
    const FPS = 30;
    const KB_SCALE = 1.1;

    for (let i = 0; i < allImages.length; i++) {
      const imgData = await fetchFile(allImages[i]);
      ffmpeg.FS("writeFile", `img${i}.png`, imgData);
    }

    for (let i = 0; i < allImages.length; i++) {
      const zoompan = `zoompan=z='min(zoom+0.0008,${KB_SCALE})':d=${DURATION*FPS}:s=${targetW}x${targetH}`;
      await ffmpeg.run(
        "-loop", "1",
        "-t", String(DURATION),
        "-i", `img${i}.png`,
        "-vf", `${zoompan},fade=t=in:st=0:d=${FADE},fade=t=out:st=${DURATION-FADE}:d=${FADE}`,
        "-pix_fmt", "yuv420p",
        "-r", String(FPS),
        `part${i}.mp4`
      );
    }

    let list = "";
    for (let i = 0; i < allImages.length; i++) {
      list += `file 'part${i}.mp4'\n`;
    }
    ffmpeg.FS("writeFile", "concat.txt", new TextEncoder().encode(list));

    await ffmpeg.run(
      "-f", "concat", "-safe", "0",
      "-i", "concat.txt",
      "-c", "copy", "output.mp4"
    );

    const data = ffmpeg.FS("readFile", "output.mp4");
    const blob = new Blob([data.buffer], { type: "video/mp4" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "video_final.mp4";
    a.click();

    statusEl.textContent = "âœ… Video generado correctamente";
  } catch (err) {
    console.error(err);
    statusEl.textContent = "âŒ Error generando el video (ver consola)";
  }
});

async function waitForFFmpeg() {
  return new Promise((resolve, reject) => {
    const check = () => {
      if (window.FFmpeg) return resolve();
      setTimeout(check, 200);
    };
    check();
  });
}
</script>
</body>
</html>
